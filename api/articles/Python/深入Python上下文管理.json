{"title":"深入Python上下文管理","slug":"Python/深入Python上下文管理","date":"2024-09-14T05:15:18.000Z","updated":"2025-08-08T17:05:18.551Z","comments":false,"path":"api/articles/Python/深入Python上下文管理.json","photos":[],"excerpt":"更优雅的资源处理范式","covers":null,"content":"<p><strong>自定义上下文管理器</strong>：</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PYTHON\"><figure class=\"iseeu highlight python\"><table><tr><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">DatabaseConnection</span>:<br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__enter__</span>(<span class=\"hljs-params\">self</span>):<br>        <span class=\"hljs-variable language_\">self</span>.conn = psycopg2.connect(DATABASE_URL)<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.conn.cursor()<br>    <br>    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__exit__</span>(<span class=\"hljs-params\">self, exc_type, exc_val, exc_tb</span>):<br>        <span class=\"hljs-keyword\">if</span> exc_type <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span>:<br>            <span class=\"hljs-variable language_\">self</span>.conn.commit()<br>        <span class=\"hljs-keyword\">else</span>:<br>            <span class=\"hljs-variable language_\">self</span>.conn.rollback()<br>        <span class=\"hljs-variable language_\">self</span>.conn.close()<br><br><span class=\"hljs-comment\"># 使用示例</span><br><span class=\"hljs-keyword\">with</span> DatabaseConnection() <span class=\"hljs-keyword\">as</span> cursor:<br>    cursor.execute(<span class=\"hljs-string\">&quot;UPDATE users SET status=1&quot;</span>)<br></code></pre></td></tr></table></figure></div>\n\n\n\n<p>高级技巧：</p>\n<ol>\n<li><p>嵌套上下文：可同时管理多个资源</p>\n</li>\n<li><p>异常处理：在__exit__中捕获并转换异常</p>\n</li>\n<li><p>异步支持：async with语法</p>\n</li>\n<li><p>函数装饰器：@contextmanager实现轻量级管理器</p>\n</li>\n</ol>\n","categories":[{"name":"Python","slug":"Python","count":2,"path":"api/categories/Python.json"}],"tags":[{"name":"Python","slug":"Python","count":1,"path":"api/tags/Python.json"},{"name":"资源管理","slug":"资源管理","count":1,"path":"api/tags/资源管理.json"}]}